name: CI for building image

#on:
#  push:
#    branches: [main]

on:
  pull_request:
    branches: [main]

jobs:
  build-image:
    runs-on: ubuntu-latest
    environment: dev

    env:
      ENVIRONMENT: ${{ vars.PKR_DEPLOYMENT_ZONE }}
      PROJECT_ID: ${{ vars.PKR_PROJECT_ID }}
      DEPLOYMENT_ZONE: ${{ vars.PKR_DEPLOYMENT_ZONE }}
      VPC_NETWORK: ${{ vars.PKR_VPC_NETWORK }}
      SOURCE_IMAGE_FAMILY: ${{ vars.PKR_SOURCE_IMAGE_FAMILY }}
      IMAGE_FAMILY: ${{ vars.PKR_IMAGE_FAMILY }}
      SSH_USERNAME: ${{ vars.PKR_SSH_USERNAME }}
      MACHINE_TYPE: ${{ vars.PKR_MACHINE_TYPE }}
      GCP_SA_KEY : ${{ secrets.GCLOUD_CREDENTIALS }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin' # GitHub doesn't support OpenJDK directly

      - name: Install PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql postgresql-contrib
          sudo systemctl start postgresql.service
          sudo -u postgres psql -c "CREATE DATABASE cloud_native_app_db;"
          sudo -u postgres psql -c "CREATE USER ${{ secrets.DB_USERNAME }} WITH ENCRYPTED PASSWORD '${{ secrets.DB_PASSWORD }}';"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE cloud_native_app_db TO ${{ secrets.DB_USERNAME }};"

      - name: Cache Maven packages #Caching before any mvn cmd, this strategy is about optimizing for future runs
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }} #new cache entry is created whenever there are changes to pom.xml, ensuring dependencies are up-to-date
          restore-keys: ${{ runner.os }}-m2

      - name: Set up Google Cloud credentials
        run: |
          echo "$GCP_SA_KEY" > /tmp/gcp-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(realpath /tmp/gcp-key.json)" >> $GITHUB_ENV

      - name: Build and test
        run: mvn clean install

      - name: Set up Packer
        uses: hashicorp/setup-packer@main
        id: setup
        with:
          version: latest

      - name: Init, Format and Validate
        run: packer/scripts/format-validate-packer.sh

      - name: Build Custom Image with Packer
        timeout-minutes: 45
        run: |
          PACKER_LOG=1 packer build -machine-readable -color=false \
            -var "environment=${ENVIRONMENT}" \
            -var "project_id=${PROJECT_ID}" \
            -var "deployment_zone=${DEPLOYMENT_ZONE}" \
            -var "vpc_network=${VPC_NETWORK}" \
            -var "source_image_family=${SOURCE_IMAGE_FAMILY}" \
            -var "image_family=${IMAGE_FAMILY}" \
            -var "ssh_username=${SSH_USERNAME}" \
            -var "machine_type=${MACHINE_TYPE}" \
            -var "artifact_path=$(pwd)/target/CloudNativeApplication-0.0.1-SNAPSHOT.jar" \
            packer/templates/webapp_server.pkr.hcl
          
  update-instance-group:
    needs: build-image
    runs-on: ubuntu-latest
    environment: dev
    env:
      ENVIRONMENT: ${{ vars.PKR_DEPLOYMENT_ZONE }}
      PROJECT_ID: ${{ vars.PKR_PROJECT_ID }}
      DEPLOYMENT_REGION: ${{ vars.GCLOUD_REGION }}
      DEPLOYMENT_ZONE: ${{ vars.GCLOUD_ZONE }}
      MACHINE_TYPE: ${{ vars.PKR_MACHINE_TYPE }}
      DB_HOST: ${{ secrets.GCLOUD_DB_HOST }}
      DB_NAME: ${{ secrets.GCLOUD_DB_NAME }}
      DB_USER: ${{ secrets.GCLOUD_DB_USER }}
      DB_PASS: ${{ secrets.GCLOUD_DB_PASS }}
      SUBNET: ${{ secrets.GCLOUD_SUBNET }}
      VPC: ${{ secrets.GCLOUD_VPC }}
      VM_SA: ${{ secrets.GCLOUD_VM_SA }}
      KEY_RING: ${{ secrets.GCLOUD_KEY_RING }}
      VM_KEY: ${{ secrets.GCLOUD_VM_KEY }}

    steps:
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0
        with:
          service_account_key: ${{ secrets.GCLOUD_CREDENTIALS }}
          project_id: ${{ env.PROJECT_ID }}
          export_default_credentials: true

      - name: Get the latest image
        id: get-latest-image
        run: |
          LATEST_IMAGE_ID=$(gcloud compute images list --project=${{ env.PROJECT_ID }} --filter="family:custom-centos-stream-webapp" --format="get(name)" --limit=1)
          echo "Latest image ID: $LATEST_IMAGE_ID"
          echo "LATEST_IMAGE_ID=$LATEST_IMAGE_ID" >> $GITHUB_ENV

      - name: Create a new instance template
        run: |
          gcloud compute instance-templates create "webapp-instance-template-cicd-$(date +%Y%m%d-%H%M%S)" \
            --project=${{ env.PROJECT_ID }} \
            --machine-type=${{ env.MACHINE_TYPE }} \
            --network=${{ env.VPC }} \
            --network-interface=network-tier=PREMIUM,subnet=${{ env.SUBNET }} \
            --metadata-from-file startup-script=packer/scripts/startup-script-instance-template.sh  \
            --can-ip-forward --maintenance-policy=MIGRATE --provisioning-model=STANDARD \
            --service-account=${{ env.VM_SA }} \
            --scopes=https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/pubsub,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write \
            --region=${{ env.DEPLOYMENT_REGION }} \
            --tags=webapp-firewall-app,webapp-firewall-http,webapp-firewall-https,webapp-firewall-ssh \
            --create-disk=auto-delete=yes,boot=yes,device-name=persistent-disk-0,image=projects/${{ env.PROJECT_ID }}/global/images/$LATEST_IMAGE_ID,kms-key=projects/${{ env.PROJECT_ID }}/locations/${{ env.DEPLOYMENT_REGION }}/keyRings/${{ env.KEY_RING }}/cryptoKeys/${{ env.VM_KEY }},mode=rw,size=20,type=pd-balanced \
            --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --reservation-affinity=any

#      - name: Update the instance group to use the new template
#        run: |
#          gcloud compute instance-groups managed set-instance-template ${{ env.MIG_NAME }} \
#            --template="webapp-template-$(date +%s)" \
#            --zone=${{ env.DEPLOYMENT_ZONE }}
#
#      - name: Start the rolling update
#        run: |
#          gcloud compute instance-groups managed rolling-action start-update ${{ env.MIG_NAME }} \
#            --version=template="webapp-template-$(date +%s)" \
#            --zone=${{ env.DEPLOYMENT_ZONE }} \
#            --type=opportunistic \
#            --minimal-action=recreate \
#            --max-surge=1 \
#            --max-unavailable=0
#
#      - name: Wait for the update to complete
#        run: |
#          gcloud compute instance-groups managed wait-until --stable ${{ env.MIG_NAME }} \
#            --zone=${{ env.DEPLOYMENT_ZONE }} \
#            --timeout=30m